<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="Author" content="无畏滴青春">
    <meta name="Keywords" content="吴哲的个人博客、个人站点、个人网站、it技术、web前端技术、网站开发、html5、css3、node、javascript、js、vue、angular、react、react-native">
    <meta http-equiv ="X-UA-COMPATIBLE" content="IE=edge,chrome=1">
    <!-- 启用360浏览器的极速模式(webkit) -->
    <meta name="renderer" content="webkit">
    <!-- 不让百度转码 -->
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <!-- 搜索引擎抓取 -->
    <meta name="robots" content="index,follow"/>
    <!-- 网站图标 -->
    <meta name="viewport" content="initial-scale=1,minimum-scale=1,user-scalable=no">
    <title>无畏滴青春的博客登录/注册</title>
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/login.css">
    <link rel="stylesheet" href="/font/iconfont.css">
</head>
<body>
<header>

</header>
<main>
    <% if(locals.login){%>
    已经登陆
    <%}else{%>
    <div class="main-content-wrap">
        <div class="login-title">
            <h1>无畏滴青春博客</h1>
        </div>
        <div class="login-register-wrap">
            <!--登录 begin-->
            <div id="login" class="login-wrap clearfix">
                <form action="/register" method="post" class="login-form">
                    <div class="username-wrap">
                        <i class="iconfont icon-username"></i>
                        <input type="text" name="user" autocomplete="off"  class="user" placeholder="用户名" />
                    </div>
                    <div class="password-wrap">
                        <i class="iconfont icon-unlock"></i>
                        <input type="password" name="pass" autocomplete="off" class="pass" placeholder="密码" />
                    </div>
                    <div class="remember-login clearfix">
                        <span class="checked-pwd">
                            <input type="checkbox" />
                             记住密码?
                        </span>
                        <div class="login-btn-wrap">
                            <input type="submit" id="loginBtn" value="登录" class="login-btn" />
                        </div>
                    </div>
                </form>
                <p class="no-account">还没有账号？点此立即
                    <span class="register-link-wrap">
                        <a class="register-link js_register_link" href="javascript:void(0);" id="registerLink">注册</a>
                    </span>
                </p>
            </div>
            <!--登录 end-->
            <!--注册 begin-->
            <div id="register" class="register-wrap">
                <form action="" method="post" class="register-form">
                    <ul>
                        <li>
                            <div>
                                <input type="text" autocomplete="off" placeholder="用户名" name="" id="username">
                            </div>
                        </li>
                        <li>
                            <div>
                                <input type="password" autocomplete="off" placeholder="密码" id="password">
                            </div>
                        </li>
                        <li>
                            <div>
                                <input type="text" autocomplete="off" placeholder="邮箱(用于邮件验证)" id="regEmail">
                            </div>
                        </li>
                        <li>
                            <div>
                                <input type="text" autocomplete="off" placeholder="验证码(证明你不是机器人)" id="regCode" class="auth-code">
                                <a href="javascript:void(0);" class="auth-wrap" title="点击更换验证码">
                                    <canvas width="384" height="50" id="code">您的浏览器不支持canvas，请升级您的浏览器！</canvas>
                                </a>
                            </div>
                        </li>
                        <li>
                            <input type="submit" value="注册" class="register-btn" id="registerBtn" />
                        </li>

                    </ul>
                </form>
                <p class="no-account">已有账号？点此立即
                    <span class="register-link-wrap">
                        <a class="register-link js_register_link" href="javascript:void(0);" id="loginLink">登录</a>
                    </span>
                </p>
            </div>
            <!--注册 end-->
        </div>
    </div>
    <%}%>
</main>
<% include footer.ejs %>
<!--<form action="/login" method="post">
    <input type="text" name="user" class="user" />
    <input type="password" name="pass" class="pass" />
    <input type="submit" />
</form>-->
<script>

    $(init);
    function init(){

        //通过请求参数(show)来决定显示登录或注册,1 显示登录 0 显示注册
        function showBlock(){

            var href = window.location.href;
            //链接是否有多个参数
            //匹配show的参数
            var regexp = /show=(\w+)/g;
            //match这里返回的数组
            var matchStr =regexp.test(href);
            console.log(RegExp.$1);
            //显示登录
            if(Number(RegExp.$1)===1){
                $('#login').show();
                $('#title').text('登录');
                $('.main-content-wrap').height(302);
            }
            else {
                //显示注册
                $('#register').show();
                $('#title').text('注册');

            }
            code= comm.validateCode('code',6);

        }
        //保存验证码
        var code = null;
        showBlock()

        //点击登录链接，显示登录
        $('#loginLink').click (function(event){
                event.stopPropagation();
                event.preventDefault();
                /*$('#login').show();
                $('#register').hide();
                $('#title').text('登录');*/
                window.location.href = '/login?show=1';
                $('.main-content-wrap').height(500);
            });

        //点击注册链接
        $('#registerLink').click(function(event){

                event.stopPropagation();
                event.preventDefault();

               /* $('#login').hide();
                $('#register').show();
                $('#title').text('注册');*/
                window.location.href = '/login?show=0';
                $('.main-content-wrap').height(302);
                //每当点击注册的a标签时候刷新验证码

                code.getNewCode();
            });

        //登录
        $("#loginBtn").click(function(e){
            e.preventDefault();
            $.ajax({
                url: '/login',
                type: 'post',
                dataType: 'json',
                data: {
                    name: $('.user').val(),
                    pass: $('.pass').val()
                },
                success: function(data){
                    console.log(data);
                    if(data.success === 1){
                       window.location.href = '/';
                    } else if(data.success === 'noactive'){
                        comm.layer.alert('对不起，您的账号还未在邮箱激活！暂不能登录！');
                    }
                },
                error: function(err){
                    console.log(err);
                }
            });
        });

        //注册
        var handleRegister = comm.throttle(handleRegisterClick,1000);
        function handleRegisterClick(){
                console.log(validateForm());
                if(validateForm()){
                    $.ajax({
                        url: '/register',
                        type: 'post',
                        dataType: 'json',
                        data: {
                            name: $('#username').val(),
                            pass: $('#password').val(),
                            email: $('#regEmail').val()
                        },
                        success: function(data){
                            if(data.status === 1){
                                var username = data.username,
                                    email = data.email;
                                window.location.href = '/register/sendsuccess?username='+username+'&email='+email;
                            }
                            if(data.status === 2){
                                code.getNewCode();
                                comm.layer.msg('用户名已存在！');
                            }

                        },
                        error: function(err){
                            code.getNewCode();
                            console.log(err);
                        }
                    });
                }
        }
        $('#registerBtn').click(function(e){
            e.preventDefault();
            handleRegister();
        });
        function validateForm() {

            //判断email
            var regEmail=/^\s*[a-zA-Z0-9]+(([\._\-]?)[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([_\-][a-zA-Z0-9]+)*(\.[a-zA-Z0-9]+([_\-][a-zA-Z0-9]+)*)+\s*$/,

                /*
                    判断用户名
                    以中文字母、下划线开头，后面是中文、字母、数字、或特殊符号
                */

                regUserName = /^([a-zA-Z]|_|[\u4e00-\u9fa5])[\u4e00-\u9fa5\w`!@#\$%\^&*()-=_+\\\[\]\{\}\|;':",\.\/<>\?]{5,19}$/g,

                /*
               *  判断密码
               *  必须以字母、_、$开头
               *  只能包含字母、数字、和特殊字符
               * */
               regPassword = /^[a-zA-Z_\$][\w`!@#\$%\^&*()-=_+\\\[\]\{\}\|;':",\.\/<>\?]{7,19}$/g,

               userName = $('#username').val(),

               email = $('#regEmail').val(),

               validateCode = $('#regCode').val(),

               password = $('#password').val();
               if(userName.length < 6||userName.length > 20){

                   comm.layer.msg('用户名必须在6到20位之间！');
                    return false;

                   if(!regUserName.test(userName)){

                       comm.layer.msg('用户名必须以中文、字母、下划线开头!');
                       return false;
                   }
               }


               if(password.length < 6 || password.length > 20){

                   comm.layer.msg('密码必须大于6位小于20位！');

                    return false;

                    if(!regPassword.test(password)){

                        comm.layer.msg('密码必须以"字母"、"_"、"$"开头!');
                        return false;
                    }
               }

               if(!regEmail.test(email)) {

                   comm.layer.msg('邮箱不正确！');
                   return false;
               }

               if(code.getContent()!== validateCode.toLowerCase()){

                    comm.layer.msg('验证码不正确');
                    code.getNewCode();

                    return false;
                }
                return true;
        }
    }
</script>
</body>
</html>