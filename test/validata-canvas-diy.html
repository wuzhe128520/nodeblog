<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>canvas验证码</title>
</head>
<body>
<canvas id="canvas" width="150" height="50"></canvas>
<a id="changeCode" href="javascript:void(0);">看不清？点我换一个</a>
<button id="requireCode">获取验证码的内容</button>
<script src="../public/js/jquery.min.js"></script>
<script>
    /**
     * id: 目标元素
     * num: 生成的验证码有几个数字或文字
     *
     */
    var validateCode = function(id,num) {

        //canvas的id
        var $canvas = $('#'+id),

             //验证码的文字库
             letters = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z',0,1,2,3,4,5,6,7,8,9],
             lettersLength = letters.length,

             //保存验证码的内容
             codeContent = '123';

             //生成的验证码的宽高
             pic_width = $canvas.width(),
             pic_height = $canvas.height();


        //随机数
        function randomNum(min,max){
            return Math.floor(Math.random()*(max-min)+min);
        }

        //随机颜色
        function randomColor(min,max){

            var _r = randomNum(min,max);
            var _g = randomNum(min,max);
            var _b = randomNum(min,max);

            return "rgb("+_r+","+_g+","+_b+")";
        }

        //画图片
        function drawValidate() {

            //getContext("2d") 对象是内建的 HTML5 对象，拥有多种绘制路径、矩形、圆形、字符以及添加图像的方法。
            ctx = $canvas.get(0).getContext("2d");

            //textBaseline 属性设置或返回在绘制文本时的当前文本基线。
            ctx.textBaseline = "bottom";

            //fillStyle 属性设置或返回用于填充绘画的颜色、渐变或模式。
            ctx.fillStyle = randomColor(180,240);

            //fillRect() 方法绘制“已填色”的矩形。默认的填充颜色是黑色。
            /**
             * context.fillRect(x,y,width,height);
             *  x: 矩形左上角的x坐标
             *  y: 矩形左上角的y坐标
             *  width: 矩形的宽度，以像素计
             *  height: 矩形的高度，以像素计
             *
             */
            ctx.fillRect(0,0,pic_width,pic_height);

            //将验证码数据给validateCode函数的变量codeContent
            codeContent = drawLetter(ctx);
            drawLine(ctx);
            drawCircle(ctx);
        }

        //画文字
        function drawLetter(ctx) {
            var code = '';
            for(var i=0; i<num; i++){

                var x = (pic_width-10)/num*i+10,
                    y = randomNum(pic_height/2,pic_height),
                    deg = randomNum(-45,45),
                    txt = letters[randomNum(0,lettersLength)],
                    code = code+ txt;
                console.log(txt);
                console.log(codeContent);
                ctx.fillStyle = randomColor(10,100);

                //font 属性设置或返回画布上文本内容的当前字体属性。
                ctx.font = randomNum(16,40)+"px SimHei";

                //translate() 方法重新映射画布上的 (0,0) 位置。
                ctx.translate(x,y);

                /**
                 * rotate(angle) 方法旋转当前的绘图。(旋转角度，以弧度计。
                 * 如需将角度转换为弧度，请使用 degrees*Math.PI/180 公式进行计算)
                 */
                ctx.rotate(deg*Math.PI/180);

                //fillText() 方法在画布上绘制填色的文本。文本的默认颜色是黑色。
                ctx.fillText(txt, 0,0);
                ctx.rotate(-deg*Math.PI/180);
                ctx.translate(-x,-y);
            }
            console.log("code:"+code);
            return code;
        }

        //画线条
        function drawLine(ctx) {

            for(var i=0; i<num; i++){

                //strokeStyle 属性设置或返回用于笔触的颜色、渐变或模式。
                ctx.strokeStyle = randomColor(90,180);

                /**
                 * beginPath() 方法开始一条路径，或重置当前的路径。
                 * 提示：请使用这些方法来创建路径：moveTo()、lineTo()、quadricCurveTo()、bezierCurveTo()、
                 * arcTo() 以及 arc()。
                 * 提示：请使用 stroke() 方法在画布上绘制确切的路径。
                 */
                ctx.beginPath();

                /*
                 moveTo() 方法将当前位置设置为 (x, y) 并用它作为第一点创建一条新的子路径。
                 如果之前有一条子路径并且它包含刚才的那一点，那么从路径中删除该子路径。
                 */
                ctx.moveTo(randomNum(0,pic_width), randomNum(0,pic_height));

                //lineTo() 方法为当前子路径添加一条直线。
                ctx.lineTo(randomNum(0,pic_width), randomNum(0,pic_height));

                /*
                * stroke() 方法绘制当前路径的边框。路径定义的几何线条产生了，但线条的可视化取决于
                * strokeStyle、lineWidth、lineJoin、lineCap 和 miterLimit 等属性。
                * 术语“勾勒”，指的是钢笔或笔刷的画笔。它意味着“画......轮廓”。
                * 和 stroke() 方法相对的是 fill()，该方法会填充路径的内部区域而不是勾勒出路径的边框。
                * */
                ctx.stroke();
            }

        }

        //画圆点
        function drawCircle(ctx) {

            for(var i=0; i < num*10; i++){

                ctx.fillStyle = randomColor(0,255);
                ctx.beginPath();

                /*
                    arc() 方法创建弧/曲线（用于创建圆或部分圆）。
                    提示：如需通过 arc() 来创建圆，请把起始角设置为 0，结束角设置为 2*Math.PI。
                */
                ctx.arc(randomNum(0,pic_width),randomNum(0,pic_height), 1, 0, 2*Math.PI);

                /*
                * fill() 方法填充路径。
                *
                * */
                ctx.fill();
            }

        }

        //处理点击验证码的事件
        function handleClick(e) {

            e.preventDefault();
            e.stopPropagation();
            drawValidate();

        }

        $($canvas).on('click',handleClick).triggerHandler('click');

        return {

            //获取验证码的内容
            getContent: function() {

                return codeContent.toLowerCase();
            },
            //获取新的验证码
            getNewCode: function() {
                $($canvas).trigger('click');
            }
        }

    };

    $(function(){
        var code = validateCode('canvas',6);
        $("#changeCode").click(function(){
            code.getNewCode();
        });

        $("#requireCode").click(function(){
            var codeContent = code.getContent();
            alert(codeContent);
        });
    });
</script>
</body>
</html>