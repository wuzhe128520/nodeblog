!function(t){var i=function(t,i,e,h){this.width=t,this.height=i,this.cropWidth=e,this.cropHeight=h,this.imageContext=this.imageCanvas=this.image=null,this.imageScale=1,this.imageViewTop=this.imageViewLeft=this.imageTop=this.imageLeft=this.imageRotation=0,this.context=this.canvas=null,this.previews=[],this.maskGroup=[],this.maskAlpha=.4,this.maskColor="#fff",this.cropTop=this.cropLeft=0,this.cropViewWidth=e,this.cropViewHeight=h,this.dragSize=7,this.dragColor="#000",this.mouseY=this.mouseX=0,this.dragTop=0,this.dragLeft=0,this.isResizing=this.isMoving=this.inDragger=this.inCropper=!1,this.cropStartHeight=this.cropStartWidth=this.cropStartTop=this.cropStartLeft=this.mouseStartY=this.mouseStartX=0};t.ImageCropper=i,i.prototype.setCanvas=function(t){this.canvas=document.getElementById(t)||t,this.context=this.canvas.getContext("2d"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.oncontextmenu=this.canvas.onselectstart=function(){return!1},this.imageCanvas=document.createElement("canvas"),this.imageContext=this.imageCanvas.getContext("2d"),this.imageCanvas.width=this.width,this.imageCanvas.height=this.height},i.prototype.addPreview=function(t){this.previews.push((document.getElementById(t)||t).getContext("2d"))},i.prototype.loadImage=function(t){if(this.isAvaiable()&&this.isImage(t)){var i=new FileReader,e=this;i.readAsDataURL(t),i.onload=function(t){e.image||(e.image=new Image),e.image.onload=function(){e._init()},e.image.src=t.target.result}}},i.prototype._init=function(){var t=Math.min(this.width/this.image.width,this.height/this.image.height);t>1&&(t=Math.min(this.cropViewWidth/this.image.width,this.cropViewHeight/this.image.height)),this.image.width*t<this.cropViewWidth&&(t=Math.min(t,this.cropViewWidth/this.image.width)),this.image.height*t<this.cropViewHeight&&(t=Math.min(t,this.cropViewHeight/this.image.height)),this.imageViewLeft=this.imageLeft=(this.width-this.image.width*t)/2,this.imageViewTop=this.imageTop=(this.height-this.image.height*t)/2,this.imageScale=t,this.imageRotation=0,t=Math.min(this.image.width*t,this.image.height*t),this.cropViewWidth=Math.min(t,this.cropWidth),this.cropViewHeight=Math.min(t,this.cropHeight),this.cropLeft=(this.width-this.cropViewWidth)/2,this.cropTop=(this.height-this.cropViewHeight)/2,this.dragLeft=this.cropLeft+this.cropViewWidth,this.dragTop=this.cropTop+this.cropViewHeight,this._update();var i=this;this.canvas.onmousedown=function(t){i._mouseHandler.call(i,t)},this.canvas.onmouseup=function(t){i._mouseHandler.call(i,t)},this.canvas.onmousemove=function(t){i._mouseHandler.call(i,t)}},i.prototype._mouseHandler=function(t){if("mousemove"==t.type){var i=this.canvas.getClientRects()[0];this.mouseX=t.pageX-i.left-$(window).scrollLeft(),this.mouseY=t.pageY-i.top-$(window).scrollTop(),this._checkMouseBounds(),this.canvas.style.cursor=this.inCropper||this.isMoving?"move":this.inDragger||this.isResizing?"se-resize":"",this.isMoving?this._move():this.isResizing&&this._resize()}else"mousedown"==t.type?(this.mouseStartX=this.mouseX,this.mouseStartY=this.mouseY,this.cropStartLeft=this.cropLeft,this.cropStartTop=this.cropTop,this.cropStartWidth=this.cropViewWidth,this.cropStartHeight=this.cropViewHeight,this.inCropper?this.isMoving=!0:this.inDragger&&(this.isResizing=!0)):"mouseup"==t.type&&(this.isMoving=this.isResizing=!1)},i.prototype._checkMouseBounds=function(){this.inCropper=this.mouseX>=this.cropLeft&&this.mouseX<=this.cropLeft+this.cropViewWidth&&this.mouseY>=this.cropTop&&this.mouseY<=this.cropTop+this.cropViewHeight,this.inDragger=this.mouseX>=this.dragLeft&&this.mouseX<=this.dragLeft+this.dragSize&&this.mouseY>=this.dragTop&&this.mouseY<=this.dragTop+this.dragSize,this.inCropper=this.inCropper&&!this.inDragger},i.prototype._move=function(){var t=this.mouseY-this.mouseStartY;this.cropLeft=Math.max(this.imageViewLeft,this.cropStartLeft+(this.mouseX-this.mouseStartX)),this.cropLeft=Math.min(this.cropLeft,this.width-this.imageViewLeft-this.cropViewWidth),this.cropTop=Math.max(this.imageViewTop,this.cropStartTop+t),this.cropTop=Math.min(this.cropTop,this.height-this.imageViewTop-this.cropViewHeight),this.dragLeft=this.cropLeft+this.cropViewWidth-this.dragSize/2,this.dragTop=this.cropTop+this.cropViewHeight-this.dragSize/2,this._update()},i.prototype._resize=function(){var t=Math.min(this.mouseX-this.mouseStartX,this.mouseY-this.mouseStartY),i=Math.max(10,this.cropStartWidth+t);t=Math.max(10,this.cropStartHeight+t),i=Math.min(i,this.width-this.cropStartLeft-this.imageViewLeft),t=Math.min(t,this.height-this.cropStartTop-this.imageViewTop),this.cropViewWidth=this.cropViewHeight=Math.round(Math.min(i,t)),this.dragLeft=this.cropLeft+this.cropViewWidth-this.dragSize/2,this.dragTop=this.cropTop+this.cropViewHeight-this.dragSize/2,this._update()},i.prototype.rotate=function(t){this.image&&(this.imageRotation+=t,this.imageViewLeft=(t=90==Math.abs(this.imageRotation%180))?this.imageTop:this.imageLeft,this.imageViewTop=t?this.imageLeft:this.imageTop,this.cropLeft=(this.width-this.cropViewWidth)/2,this.cropTop=(this.height-this.cropViewHeight)/2,this.dragLeft=this.cropLeft+this.cropViewWidth-this.dragSize/2,this.dragTop=this.cropTop+this.cropViewHeight-this.dragSize/2,this._update())},i.prototype._update=function(){this.context.clearRect(0,0,this.width,this.height),this._drawImage(),this._drawMask(),this._drawDragger(),this._drawPreview()},i.prototype._drawImage=function(){this.imageContext.clearRect(0,0,this.width,this.height),this.imageContext.save();var t=this.imageRotation%360;switch(this.imageContext.translate(this.imageViewLeft,this.imageViewTop),this.imageContext.scale(this.imageScale,this.imageScale),this.imageContext.rotate(this.imageRotation*Math.PI/180),(360-t)%360){case 90:this.imageContext.drawImage(this.image,-this.image.width,0);break;case 180:this.imageContext.drawImage(this.image,-this.image.width,-this.image.height);break;case 270:this.imageContext.drawImage(this.image,0,-this.image.height);break;default:this.imageContext.drawImage(this.image,0,0)}this.imageContext.restore(),this.context.drawImage(this.imageCanvas,0,0)},i.prototype._drawPreview=function(){for(var t=0;t<this.previews.length;t++){var i=this.previews[t];i.clearRect(0,0,i.canvas.width,i.canvas.height),i.save(),i.drawImage(this.imageCanvas,this.cropLeft,this.cropTop,this.cropViewWidth,this.cropViewHeight,0,0,i.canvas.width,i.canvas.height),i.restore()}},i.prototype._drawMask=function(){this._drawRect(this.imageViewLeft,this.imageViewTop,this.cropLeft-this.imageViewLeft,this.height,this.maskColor,null,this.maskAlpha),this._drawRect(this.cropLeft+this.cropViewWidth,this.imageViewTop,this.width-this.cropViewWidth-this.cropLeft+this.imageViewLeft,this.height,this.maskColor,null,this.maskAlpha),this._drawRect(this.cropLeft,this.imageViewTop,this.cropViewWidth,this.cropTop-this.imageViewTop,this.maskColor,null,this.maskAlpha),this._drawRect(this.cropLeft,this.cropTop+this.cropViewHeight,this.cropViewWidth,this.height-this.cropViewHeight-this.cropTop+this.imageViewTop,this.maskColor,null,this.maskAlpha)},i.prototype._drawDragger=function(){this._drawRect(this.dragLeft,this.dragTop,this.dragSize,this.dragSize,null,this.dragColor,null)},i.prototype._drawRect=function(t,i,e,h,s,o,a){this.context.save(),null!==s&&(this.context.fillStyle=s),null!==o&&(this.context.strokeStyle=o),null!==a&&(this.context.globalAlpha=a),this.context.beginPath(),this.context.rect(t,i,e,h),this.context.closePath(),null!==s&&this.context.fill(),null!==o&&this.context.stroke(),this.context.restore()},i.prototype.getCroppedImageData=function(t,i,e){var h=document.createElement("canvas");return h.width=t||this.cropWidth,h.height=i||this.cropHeight,h.getContext("2d").drawImage(this.imageCanvas,this.cropLeft,this.cropTop,this.cropViewWidth,this.cropViewHeight,0,0,h.width,h.height),h.toDataURL(e||"image/jpeg")},i.prototype.isAvaiable=function(){return"undefined"!=typeof FileReader},i.prototype.isImage=function(t){return/image/i.test(t.type)}}(window);