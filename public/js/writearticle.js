!function(){function e(e){var t=$("<span></span>");return t.text(e),t}function t(e,t){$("#"+e).empty().append(t),n(),$("#addTag").off("click").on("click","span",function(){d($(this))})}function n(){$("#tagInput").css("paddingLeft",$("#addTag").width())}function i(e,t){return comm.ary.deleteByValue(e,t)}function a(e){var t=b.length,n=0,i=e.length,a=!0;if(t>=5||i<1)return!1;if(t+i>5){i=5-t;for(var c=e.slice(i-1),o=0,r=c.length;o<r;o++)u(c[o])}for(;n<i;n++){var l=comm.exp.trimAllSpace(e[n]);l&&","!==l&&-1===b.indexOf(l)&&(b.push(l),a=!1)}return a}function c(){for(var n=0,i="",a=b.length;n<a;n++)i+=e(b[n]).prop("outerHTML");t("addTag",i)}function o(){var e=r();e&&(b=i(b,e.text()))}function r(e){var t=$("#addTag").find("span"),i=0,a=null,c=t.length;if("string"==typeof e)for(;i<c;i++){var o=t.eq(i);if(o.text()===e){a=o,a.remove();break}}else c>0&&(a=t.eq(c-1),a.remove(),n());return a&&u(a.text()),a}function u(e){$("#hasTag").find("input:checked").each(function(t,n){var i=$(this).siblings("label"),a=i.text();if(e===a)return $(this).get(0).checked=!1,!1})}function l(){var e=$("#hasTag");e.is(":hidden")&&(e.show(),e.off("click").on("change","input[type='checkbox']",function(){var e=$(this),t=e.siblings("label").eq(0).text();if(this.checked)if(p()){var o=a([t]);o||c()}else this.checked=!1;else b=i(b,t),r(t),n()}))}function s(e,t){var n=null;if(e.off("keyup"),!t)return!1;t=t.replace(/，/g,",").replace(/,{2,}/g,",").replace(/(^\s*)|(\s*$)/g,""),n=t.split(","),n=comm.ary.removeDuplicated(n),a(n),c(),e.val("")}function f(e,t){var n=e.val();e.off("keyup").on("keyup",function(t){0===n.length&&8===t.keyCode&&o(),n=$.trim(e.val())}),l()}function d(e){e.remove(),b=i(b,e.text()),n()}function p(){var e=$("#hasTag").find("input[type='checkbox']:checked").length;return!(m().length+1+e>5)}function m(){for(var e=g(),t=0,n=comm.ary.cloneAry(b),i=e.length;t<i;t++){var a=n.indexOf(e[t]);n.splice(a,1)}return n}function h(){var e=$("#hasTag").find("input:checked"),t=[];return e.each(function(e,n){t.push(parseInt($(this).data("tagid")))}),t}function g(){var e=$("#hasTag").find("input:checked"),t=[];return e.each(function(e,n){t.push($(this).siblings("label").eq(0).text())}),t}function v(){comm.layer.dialog({type:1,area:["200px","200px"],title:"添加分类",content:$("#addType").html(),btn:["添加","取消"],methods:[function(e){if(y()){var t=$.trim($("#addTypeWrap").find(".js_addtype_input").eq(0).val());comm.layer.close(e),x(t)}},function(e){}],move:!1,closeBtn:0})}function y(){var e=$("#addTypeWrap").find(".type-input").eq(0),t=e.val(),n=t.length,i=$.trim(t);return e.val(i),i?n>0&&n<=10?($(".errTip").is(":hidden")||$(".errTip").hide(),!0):($(".errTip").text("长度不能大于10").show(),!1):($(".errTip").text("类别不能为空").show(),e.focus(),!1)}function x(e){comm.ajax.commAjax({url:"/admin/addtype",type:"post",data:{typename:e},successFn:function(e){e.status&&(k(),comm.layer.msg(e.des))},errorFn:function(e){comm.layer.alert(e)}})}function k(){comm.ajax.commAjax({url:"/admin/gettypes",successFn:function(e){e&&comm.tmpl.render("addTypeTmpl",{types:e},"hastype")},errorFn:function(e){comm.layer.msg("查询分类失败"+e)}})}var T=UE.getEditor("editor"),b=[];$("#tagInput").on("blur",function(e){var t=$(this);s(t,$.trim(t.val()))}),$("#tagInput").on("focus",function(e){f($(this),e)}),$("#addTypeLink").on("click",function(e){v()}),$("#declare").on("click",function(e){var t=T.getContent(),n=T.getContentTxt(),i=$("#imgSrc").val().replace(/\\/g,"/"),a=m(),c=h();e.preventDefault(),comm.ajax.commAjax({url:"/admin/article",type:"post",data:{title:$("#title").val(),newTags:a.join(","),oldTagIds:c.join(","),type:$("#hastype").find("input:checked").eq(0).val(),author:$("#author").val(),summery:n,content:t,imgSrc:i},successFn:function(e){e.status?($(".admin-success").show(),comm.effect.countDown("seconds",3,function(){window.location.href="/article-detail/"+e.insertId+".html"})):comm.layer.msg("发表文章失败！")}})}),$("#chooseFile").click(function(){$("#file").click()})}();